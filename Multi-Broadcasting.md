# Multi-broadcasting

by Stéphane Lepin

**Current State**: phase 2 coding

### Weekly schedule

#### Phase 1: Broadcasting profiles

##### May 30 - June 2nd

  - Write the BroadcastProfile class and its XML load/save code

##### June 5 - June 9

  - Refactor the BroadcastSettings class as a "proxy" between
    DlgPrefBroadcast and instances of BroadcastProfile
  - ~~Refactor the Live Broadcasting preferences panel~~ (obsolete)

##### June 12 - June 16

  - Testing and bug hunting

##### June 19 - June 23

  - **First milestone: have this feature mergeable**

**Work on Phase 1 is over. Schedule may differ from actual progress, see
weekly reports for this.**

#### Phase 2: Multi-broadcasting

##### June 26 - June 30

  - School project

##### July 3 - July 7

  - Libshout streaming logic separate from EngineBroadcast to new class
    ShoutOutput
  - Add QList\<ShoutOutput\> instance list to EngineBroadcast

##### July 10 - July 14

  - Keep BroadcastSettings' profile list in sync with EngineBroadcast's
    instance list
  - Only on "Apply" button click on Live Broadcasting preferences
  - Active connections shouldn't be restarted
  - Begin work on settings UI refactor
  - BroadcastSettings: add "rename profile" method

##### July 17 - July 21

  - Continue work on settings UI refactor
  - Implement password encryption in BroadcastProfile

-----

### Project description

This project for Mixxx aims to add several features potentially useful
for users willing to broadcast live with Mixxx. Two new features will be
implemented : broadcasting profiles and multiple broadcasting outputs.
These features will be implemented in two parts, matching the GSoC
phases schedule.

### Phase 1: Broadcasting profiles subsystem

Broadcasting profiles allow management of several sets of server
settings/credentials and encoder settings. These will be managed through
dedicated controls in Mixxx's existing Live Broadcasting preferences UI.
Profiles have the standard Icecast/Shoutcast and encoder settings
currently available in the Live Broadcasting panel. The goal of Phase 1
is to replace the existing Live Broadcasting settings subsystem (in
mixxx.cfg) with a new XML subsystem of profiles within the existing UI.
The new UI along with multi-broadcasting is the goal of Phase 2.

#### Technical details

  - Profiles are saved as \*.bcp.xml files under a "broadcast\_profiles"
    subdirectory in the settings folder. This file nature is hidden from
    the user, and the profile list in the preferences UI is built by
    listing files in that folder.
  - Create a new BroadcastProfile class:
  - Move all properties from BroadcastSettings to BroadcastProfile
  - The BroadcastProfile class takes care of its
    serialization/deserialization from/to XML, using Qt's built-in XML
    features

<!-- end list -->

``` 
    * save() method to save the profile
    * Parameterized constructor or static method to build an instance based on an existing .bcp.xml file
* The XML document generated by an instance of BroadcastProfile has the profile's name as its filename
* Refactor the BroadcastSettings class:
* Move all properties to BroadcastProfile
* Keep a QList of broadcast profiles
* Add a method to fill the QList of broadcast profiles by listing the contents of the "broadcast_profiles" settings subdirectory and call this method in the constructor
```

##### UML diagrams

|                                              |                                             |
| -------------------------------------------- | ------------------------------------------- |
| [[/media/wiki/gsoc_palakis_phase1_umlbefore.png|]] | [[/media/wiki/gsoc_palakis_phase1_umlafter.png|]] |
| *Class structure before modifications*       | *Class structure after modifications*       |

-----

### Phase 2: Multiple broadcasting outputs

The new “Live Broadcasting” settings panel will consist of a list of
broadcasting outputs, with the existing settings form under the
connections table. Editing a connection profile will be made through the
refactored existing UI.

[[/media/multi-broadcasting.png|]]

#### Technical details

  - The current libshout logic in EngineBroadcast must be separated from
    it and moved to a new class ShoutOutput (with QThread inheritance)
  - Class methods:

<!-- end list -->

``` 
    * Set broadcasting profile (instance of BroadcastProfile)
    * Start output (overrides QThread::run)
    * Stop output
    * Slot: Push uncompressed audio samples to output
* The EngineBroadcast sidechain filter must be refactored to only act as a "broadcast manager" that receives audio samples and pushes them to output instances
* The Live Broadcasting settings UI must be updated (see UI mockup above)
* If time allows it:
* Implement password encryption (see [[https://bugs.launchpad.net/mixxx/+bug/1642765]])
* Add AAC support for streaming 
    * Encoder: maybe possible with FFmpeg's new built-in aac encoder
    * Libshout support: See [[https://bugs.launchpad.net/mixxx/+bug/726991]]
```

<span class="underline">Possible evolutions</span>:

  - Implement Shoutcast 2 support
  - Add an Opus streaming encoder
  - Make the broadcasting code more generic and not specific to
    libshout.

-----

### Weekly reports

#### Week 1: May 30th - June 2th

I wrote the implementation for the BroadcastProfile class: it currently
has its XML load/save code that needs to be tested and the get/set
behaviour of settings is a bit different compared to the settings
management in BroadcastSettings: settings get/set methods in
BroadcastSettings (that will be removed) "directly talk" with the
mixxx.cfg file, while BroadcastProfile stores values temporarily in
private members until save() is called to write the values to the
profile's XML file. Also, methods beginning with "getDefault" don't
exist in BroadcastProfile because these are set on instanciation of the
class.

I got a bit late because of dev setup issues on my Windows system: I
tried to work on Mixxx with Eclipse on Windows by using the build.bat
provided in the Windows Dev Setup guide from the wiki. Building works,
cleaning too (with a small addition to the Batch script) but Eclipse's
"code checker" throws a lot of errors about undefined symbols (for the
record: include paths for Qt and Mixxx's source code where added in the
project's settings, along with appropriate search paths). In the end, I
switched to Qt Creator, and it suits me for now.

For the next week of coding, I expect to have results on the XML
profiles load/save mechanisms and UI by Friday.

#### Week 2: June 5 - June 9

I refactored BroadcastSettings as a manager of BroadcastProfile
instances. It's integrated in the current UI, which saves settings to a
file named "Default Profile.bcp.xml" in
$SETTINGS\_DIR/broadcast\_profiles.

Actual implementation of BroadcastProfile differs a bit from the
original design: file management (create/rename/delete/open) was
initially planned to be done in a profile instance itself, but was
eventually moved to BroadcastSettings to have this responsibility
handled in a single class instead of several parts across several
classes. However, the XML save/load code is still the responsibility of
BroadcastProfile.

I got late with UI, so next week's plan is:

  - First, make sure BroadcastSettings is instancianted only once
  - Replace instances in DlgPrefBroadcast and EngineBroadcast with a
    pointer to a single instance
  - Work on UI from Monday to Wednesday
  - Testing during the remaining days.

#### Week 3: June 12 - June 16

I had progress on the UI but there was still a lot of work left to do to
make sure everything is functioning properly. Instead of implementing
the new Broadcasting Profiles UI, Daniel and I agreed on a slimmed-down
schedule for the remaining of phase 1. The plan is to focus on the XML
profile subsystem to have a good foundation for multiple broadcasting
outputs (a.k.a multi-broadcasting, each profile being a connection) for
phase 2, with proper instance reference passing and unit tests. See
[this Pull Request](https://github.com/mixxxdj/mixxx/pull/1283).

The UI will be left untouched, and the work already done is kept
separately for later re-use.

#### Week 4: June 19 - June 23

Work went as planned for this week: unit tests for BroadcastProfile were
written, pointers to BroadcastProfile instances are now QSharedPointers,
turned BroadcastSettings into a Qt object to be able to implement basic
read-only model support and profile name synchronization with signals &
slots between BroadcastSettings' hashmap and the instances' name
attribute. getCurrentProfile and setCurrentProfile were deleted because
no longer useful, and were instead replaced with a more future-proof
call to profileAt(int) that returns a profile based on its list index.
Seems like work on Phase 1 is over. Further additions will come during
phase 2, where those will be testable.

#### Week 5: June 26 - June 30

School project

#### Week 6: July 3 - July 7

So here starts Phase 2, where I get to implement multi-broadcasting\!
The streaming code has been separated from EngineBroadcast into a new
class (ShoutOutput) that can be instanciated as needed. A ShoutOutput
instance is linked with a profile pointer (BroadcastProfilePtr). Values
are passed to libshout on connection start and when settings are applied
from the Live Broadcasting preferences panel. Frames are polled from
EngineBroadcast's thread like before, but are then passed to each
ShoutOutput's process() method. Connections within EngineBroadcast are
kept in sync with BroadcastSettings' profiles list using several
signals/slots.

Currently I see one design flaw in my code: instead of passing a
BroadcastProfilePtr to a ShoutOutput, ShoutOutput should be a child
class of BroadcastProfile. Since the profile is never changed during the
lifetime of a ShoutOutput instance, this would make the link between the
two more obvious and logical.

Week 7's work is for the Preferences UI. Testing is already possible
with the current UI, and the first WIP of the new UI will allow for
testing on several streaming outputs.

#### Week 7: July 10 - July 14

*Work in progress*
